USE [pangya]
GO
/****** Object:  StoredProcedure [pangya].[ProcGetGuilds]    Script Date: 26/11/2023 16:14:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [pangya].[ProcGetGuilds]
AS
BEGIN
    SET NOCOUNT ON;
	SELECT 
		A.GUILD_UID,
		ISNULL(A.GUILD_NAME, N'GUILD_NAME') as GUILD_NAME,
		COUNT(pm.GUILD_UID) AS MEMBERS,
		ISNULL(A.GUILD_MARK_IMG, N'guildmark') AS GUILD_MARK_IMG,
		A.GUILD_INFO,
		A.GUILD_PANG,
		A.GUILD_POINT,
		A.GUILD_LEADER AS GUILD_LEADER_UID,
		b.NICK AS GUILD_LEADER_NICKNAME,
		CAST(a.GUILD_REG_DATE as NVARCHAR(10)) as GUILD_REG_DATE
	FROM pangya.pangya_guild A
	INNER JOIN pangya.account B ON A.GUILD_LEADER = B.[uid]
	LEFT JOIN pangya.pangya_guild_member pm ON A.GUILD_UID = pm.GUILD_UID AND pm.MEMBER_STATE_FLAG < 9
	GROUP BY 
		A.GUILD_UID, A.GUILD_NAME, A.GUILD_MARK_IMG, A.GUILD_INFO, A.GUILD_PANG, A.GUILD_POINT,
		A.GUILD_LEADER, b.NICK, a.GUILD_REG_DATE
	ORDER BY		
		a.GUILD_UID
END
